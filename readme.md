# Инструкция по развертыванию и настройке приложения

## 1. Первоначальное развертывание

### 1.1 Клонируем репозиторий
```commandline
git clone https://git.omnissiah-codex.internal/omnissiah-codex/magos_medtests_offline.git
cd magos_medtests_offline
```

### 1.2 Настраиваем переменные окружения
Создайте файл `.env` (можно скопировать из `.env.example`, если он существует) и заполните его необходимыми значениями для подключения к базе данных и работы приложения.

### 1.3 Собираем и запускаем приложение
Эта команда соберет Docker-образы и запустит контейнеры в фоновом режиме.
```commandline
make up-prod
```

---
## 2. Создание структуры базы данных. ОЧЕНЬ ВАЖНО!

### 2.1 Инциализируем БД и создаем таблицы
После первого запуска контейнеров необходимо создать структуру таблиц в базе данных с помощью следующей команды:
```commandline
make init_db 
```
*(Эта команда создаст и применит самую первую миграцию. Если она завершится с ошибкой, смотрите раздел "Решение проблем" ниже).*


---
## 3. Настройки для подключения через pgAdmin

Для подключения к базе данных из pgAdmin используйте следующие параметры (фактические значения берите из вашего `.env` файла).

| Параметр в pgAdmin | Значение | Источник |
| :--- | :--- | :--- |
| **Host name/address**| `192.168.0.250` | IP-адрес виртуальной машины с Docker |
| **Port** | `5433` | Внешний порт из `docker-compose.yml` (`"5433:5432"`) |
| **Maintenance database**| `tests_db` | Значение `POSTGRES_DB` из `.env` |
| **Username** | `postgres` | Значение `POSTGRES_USER` из `.env` |
| **Password** | `postgres` | Значение `POSTGRES_PASSWORD` из `.env` |


---
## 4. Резервное копирование и восстановление

Для создания и восстановления бэкапов рекомендуется использовать утилиты командной строки `pg_dump` и `pg_restore`, так как они работают надежнее графического интерфейса pgAdmin, особенно с большими объемами данных.

### 4.1 Создание дампа (только данные)

Следующая команда создаст сжатый дамп, содержащий только данные из таблицы `test_results`.

```commandline
pg_dump -U postgres -h 192.168.0.250 -p 5433 -d tests_db \
-t test_results --data-only --inserts --on-conflict-do-nothing \
-Fc -f test_results_data.dump
```

**Ключевые флаги:**
*   `--data-only`: Сохраняет только данные, без структуры таблицы.
*   `--inserts --on-conflict-do-nothing`: Создает идемпотентный дамп. При восстановлении существующие записи будут проигнорированы, а не вызовут ошибку.
*   `-Fc`: Создает дамп в сжатом формате `custom`, который используется `pg_restore`.
*   `-f test_results_data.dump`: Имя выходного файла.

### 4.2 Восстановление дампа

> **Внимание!** Перед восстановлением дампа, созданного с опцией `--data-only`, таблица `test_results` уже должна существовать в базе данных (например, создана миграциями).

Команда для восстановления данных из файла:

```commandline
pg_restore -U postgres -h 192.168.0.250 -p 5433 -d tests_db \
--data-only test_results_data.dump
```
При запросе нужно будет ввести пароль от базы данных.


## 5. Управление проектом через Makefile

Для упрощения работы с Docker-контейнерами в проекте используется `Makefile`. Он предоставляет набор коротких и понятных команд для управления жизненным циклом приложения, таких как запуск, остановка и просмотр логов.

Команды разделены на группы для **Development** и **Production** окружений, а также общие команды для обслуживания.

### Список команд

| Команда | Описание |
| :--- | :--- |
| **Development** | |
| `make up` | Собирает (если нужно) и запускает контейнеры для **разработки** в фоновом режиме. |
| `make down` | Останавливает и удаляет контейнеры для **разработки**. |
| `make bash` | Открывает интерактивную `bash`-сессию внутри **dev**-контейнера приложения. |
| `make logs` | Показывает логи **dev**-контейнера приложения в реальном времени. |
| **Production** | |
| `make up-prod` | Собирает и запускает контейнеры для **production** в фоновом режиме. |
| `make down-prod` | Останавливает и удаляет контейнеры для **production**. |
| `make bash-prod` | Открывает `bash`-сессию внутри **prod**-контейнера приложения. |
| `make logs-prod` | Показывает логи **prod**-контейнера приложения в реальном времени. |
| **Инициализация БД** | |
| `make init_db` | Выполняет **первоначальную** настройку базы данных: создает и применяет самую первую миграцию (`init`). Выполняется один раз при старте проекта. |
| **Системные команды** | |
| `make clear-volume` | ⚠️ **(Опасно)** Удаляет том с данными **dev**-базы данных. **Все данные будут потеряны.** Запрашивает подтверждение. |
| `make prune` | **(Безопасно)** 'Мягкая' очистка: удаляет остановленные контейнеры и неиспользуемые (dangling) образы. |
| `make clean` | ☢️ **(Очень опасно)** 'Жесткая' очистка: удаляет **ВСЁ** неиспользуемое на **ВСЕЙ СИСТЕМЕ** (контейнеры, образы, сети, тома). Запрашивает подтверждение. |


## 6. Решение проблем

### Ошибка при инициализации базы данных
Если команда make init_db завершается с ошибкой, наиболее вероятная причина в том, что база данных уже не пуста (например, от предыдущих неудачных запусков). Чтобы это исправить, нужно полностью очистить том с данными PostgreSQL.
> ⚠️ **Внимание!** Следующая команда полностью **УДАЛИТ ВСЕ ДАННЫЕ** из вашей базы.

```commandline
# 1. Остановите все контейнеры
docker-compose down

# 2. Найдите имя тома (например, magos_medtests_offline_postgres_data)
docker volume ls

# 3. Удалите том
docker volume rm <имя_тома>

# 4. Снова запустите приложение и начните с пункта 1.3
make up-prod
```

