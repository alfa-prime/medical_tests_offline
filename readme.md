# Инструкция по развертыванию и настройке приложения

## 1. Первоначальное развертывание

### 1.1 Клонируем репозиторий
```commandline
git clone https://git.omnissiah-codex.internal/omnissiah-codex/magos_medtests_offline.git
cd magos_medtests_offline
```

### 1.2 Настраиваем переменные окружения
Создайте файл `.env` (можно скопировать из `.env.example`, если он существует) и заполните его необходимыми значениями для подключения к базе данных и работы приложения.

### 1.3 Собираем и запускаем приложение
Эта команда соберет Docker-образы и запустит контейнеры в фоновом режиме.
```commandline
bash make up-prod
```

---
## 2. Создание структуры базы данных

### 2.1 Заходим в консоль контейнера
```commandline
make bash-prod
```

### 2.2 Создаем первоначальную миграцию
На этом шаге Alembic сгенерирует скрипт для создания таблиц. Поле `result` будет иметь стандартный текстовый тип, понятный для Alembic.
```commandline
alembic revision --autogenerate -m "init"
```
*(Если возникает ошибка, смотрите раздел "Решение проблем" в конце инструкции).*

### 2.3 Применяем миграцию
Эта команда создаст таблицы в базе данных в соответствии со сгенерированным скриптом.
```commandline
alembic upgrade head
```

---
## 3. "Ручное" включение шифрования в приложении

> **Объяснение:** Alembic не умеет автоматически генерировать миграции для кастомного типа `EncryptedString`. Поэтому мы сначала создали таблицу со стандартным типом, а теперь изменим модель в коде, чтобы SQLAlchemy начал шифровать/дешифровать данные при работе с этой колонкой.

### 3.1 Редактируем модель внутри контейнера
Открываем файл для редактирования. `micro` — это простой текстовый редактор, уже установленный в контейнере.
```commandline
micro app/model/dbase.py
```

### 3.2 Заменяем тип колонки
Найдите строку:
```python
result: Optional[str]
```
И замените ее на:
```python
result: Optional[str] = Field(default=None, sa_column=Column(EncryptedString))
```

### 3.3 Сохраняем и выходим
- Нажмите `Ctrl+S`, чтобы сохранить изменения.
- Нажмите `Ctrl+Q`, чтобы выйти из редактора `micro`.

### 3.4 Выходим из консоли контейнера
```commandline
exit
```

**Важное примечание:** Поскольку эти изменения сделаны **только внутри контейнера**, они будут потеряны при его пересоздании (например, после `docker-compose down`). Этот шаг нужно будет повторять при каждом "чистом" развертывании.

---
## 4. Перезапуск приложения

Чтобы приложение начало работать с обновленной моделью (использовать `EncryptedString`), необходимо перезапустить контейнер.
```commandline
docker-compose restart app
```

---
## 5. Настройки для подключения через pgAdmin

Для подключения к базе данных из pgAdmin используйте следующие параметры (фактические значения берите из вашего `.env` файла).

| Параметр в pgAdmin | Значение | Источник |
| :--- | :--- | :--- |
| **Host name/address**| `192.168.0.250` | IP-адрес виртуальной машины с Docker |
| **Port** | `5433` | Внешний порт из `docker-compose.yml` (`"5433:5432"`) |
| **Maintenance database**| `tests_db` | Значение `POSTGRES_DB` из `.env` |
| **Username** | `postgres` | Значение `POSTGRES_USER` из `.env` |
| **Password** | `postgres` | Значение `POSTGRES_PASSWORD` из `.env` |


---
## Решение проблем

### Ошибка при создании первой миграции ("init")
Если команда `alembic revision --autogenerate -m "init"` падает, это обычно означает, что база данных уже не пуста. Чтобы это исправить, нужно полностью очистить том с данными PostgreSQL.

> ⚠️ **Внимание!** Следующая команда полностью **УДАЛИТ ВСЕ ДАННЫЕ** из вашей базы.

```commandline
# 1. Остановите все контейнеры
docker-compose down

# 2. Найдите имя тома (например, magos_medtests_offline_postgres_data)
docker volume ls

# 3. Удалите том
docker volume rm <имя_тома>

# 4. Снова запустите приложение и начните с пункта 1.3
make up-prod
```